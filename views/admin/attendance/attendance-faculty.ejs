<%- include('../../partials/top-bar') %>

      <!-- Site wrapper -->
      <div class="wrapper">
         <%- include('../../partials/header') %>
		
         <!-- =============================================== -->
         <!-- Left side column. contains the sidebar -->
       <%- include('../../partials/sidebar') %>
	
   
         <!-- =============================================== -->
         <!-- Content Wrapper. Contains page content -->
         <div class="content-wrapper">
			  
            <!-- Content Header (Page header) -->
            <section class="content-header">
               <div class="header-icon">
                  <i class="fa fa-dashboard"></i>
               </div>
               <div class="header-title">
                  <h1>SMART SCHOOL Dashboard</h1>
                  <small>Very detailed & featured admin.</small>
               </div>
            </section>
			
            <!-- Main content -->
            <section class="content">
          
<div class="panel panel-bd lobidrag">
                        <div class="panel-heading">
                           <div class="btn-group" id="buttonexport">
                              <a href="#">
                                 <h4>Faculty Attendance</h4>
                              </a>
                           </div>
                        </div>
                        <div class="panel-body">
 <% if(user[0].role == "faculty"){ %> 
                                <div align="right">
                                  <% if(data.length>0){ %>

                                    <% if(data[0].check_in_flag === "0" && data[0].check_out_flag === "0"){ %>
                                    <a href="#" class="btn btn-add checkedIn text-right" id="checkedIn"><i class="fa fa-plus"></i>Check IN</a> 

                                     <% }else if(data[0].check_in_flag === "1" && data[0].check_out_flag === "0"){  %>
                               
                                  <a href="#" class="btn btn-add checkedOut text-right" id="checkedOut"><i class="fa fa-plus"></i>Check OUT</a> 
                                    <% }else{%>
                               
                                  <a href="#" class="btn btn-add text-right" disabled><i class="fa fa-plus"></i>Checked OUT</a> 
                                    <% } %>
                                       <% }else{ %> 
                                 <a href="#" class="btn btn-add checkedIn text-right" id="checkedIn"><i class="fa fa-plus"></i>Check IN</a> 
                                 <% } %>
                                 </div>
                                    <% } %>
                                     <% if(user[0].role == "faculty"){ %> 
                                <div class="row"> 
                 
                   <div class="col-xs-12 col-sm-6 col-md-6 col-lg-3">
                       <b> Checkin Time :  <span id="checkin_time"> </span></b>
                       
                  </div>
                   <div class="col-xs-12 col-sm-6 col-md-6 col-lg-3">
                       <b> Checkout Time : <span id="checkout_time"> </span></b>
                       
                  </div>
                  </div>
                    <% } %>
                  <br>
			<div class="row"> 
  <% if(user[0].role == "school"){ %> 
								  <div class="form-group col-lg-4">
                                    <label>Faculty Name( only for school)</label>
                                   <select name="faculty_id" id="faculty_id" class="form-control" required="">
                                    <option value="">Please Select</option>
                                     <% if(data.length){ %>
                                       <% for(let i=0; i<data.length; i++){ %>

                                       <option value="<%= data[i].track_id  %>"><%= data[i].name  %></option>

                                        <% } %>
                                        <% } %>
                                       
                                   </select> 
                                </div>

                                <% } %>
                                 <div class="form-group col-lg-4">
                                      <label>Select Date Range</label><br>
                                  <div id="reportrange"  class="pull-left" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc;">
                                    <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp;
                                    <span></span> <b class="caret"></b>
                                 </div>
                                
                                 </div>
         <div class="form-group col-lg-3">
                                      <label></label><br>
                                       <% if(user[0].role == "school"){ %> 
                                <button class="btn btn-success" id="filter_records">Filter</button>
                                  <% } %> 
                                   <% if(user[0].role == "faculty"){ %> 
                                <button class="btn btn-success" id="filter_records_by_faculty">Filter</button>
                                  <% } %> 
                              
                              </div>
           
			<br>
        </div>
					 
		<br>

					<div class="table-responsive">
						
						<table id="sample_data" class="table table-bordered table-striped">
						
							<thead>
								<tr>
									<th> Date</th>
								
									<th>Status</th>
									<th>Check IN</th>
									<th>Check OUT</th>
								</tr>
							</thead>
						</table>
					</div>
				</div>
			</div>
		
            </section>
		

            <!-- /.content -->
         </div>
         <!-- /.content-wrapper -->
        <%- include('../../partials/footer') %>
      </div>
	   <div class="modal fade" id="addtask" tabindex="-1" role="dialog">
                  <div class="modal-dialog">
                     <div class="modal-content">
                        <div class="modal-header modal-header-primary">
                           <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                           <h3><i class="fa fa-plus m-r-5"></i> add new task</h3>
                        </div>
                        <div class="modal-body">
                           <div class="row">
                              <div class="col-md-12">
                                 <form class="form-horizontal">
                                    <fieldset>
                                       <!-- Text input-->
                                       <div class="col-md-6 form-group">
                                          <label class="control-label">Task Name</label>
                                          <input type="text" placeholder="Task Name" class="form-control">
                                       </div>
                                       <div class="col-md-6 form-group">
                                          <label class="control-label">Due date</label>
                                          <input type="number" placeholder="Due title" class="form-control">
                                       </div>
                                       <div class="col-md-6 form-group">
                                          <label class="control-label">Description</label>
                                          <input type="text" placeholder="Description" class="form-control">
                                       </div>
                                       <div class="col-md-6 form-group">
                                          <label class="control-label">Assign to</label>
                                          <input type="text" placeholder="Assign to" class="form-control">
                                       </div>
                                       <!-- Text input-->
                                       <div class="col-md-6 form-group">
                                          <label class="control-label">status</label>
                                          <input type="text" placeholder="status" class="form-control">
                                       </div>
                                       <div class="col-md-12 form-group user-form-group">
                                          <div class="pull-right">
                                             <button type="button" class="btn btn-danger btn-sm">Cancel</button>
                                             <button type="submit" class="btn btn-add btn-sm">Update</button>
                                          </div>
                                       </div>
                                    </fieldset>
                                 </form>
                              </div>
                           </div>
                        </div>
                        <div class="modal-footer">
                           <button type="button" class="btn btn-danger pull-left" data-dismiss="modal">Close</button>
                        </div>
                     </div>
                     <!-- /.modal-content -->
                  </div>
                  <!-- /.modal-dialog -->
               </div>
      <!-- /.wrapper -->
      <!-- Start Core Plugins
         =====================================================================-->
   <%- include('../../partials/footer-script') %>

   <script nonce="<%= nonce %>" type="text/javascript" language="javascript">

$(document).ready(function(){
	

	toastr.options = {
				'closeButton': true,
				'debug': false,
				'newestOnTop': false,
				'progressBar': true,
				'positionClass': 'toast-top-center',
				'preventDuplicates': false,
				'showDuration': '1000',
				'hideDuration': '1000',
				'timeOut': '5000',
				'extendedTimeOut': '1000',
				'showEasing': 'swing',
				'hideEasing': 'linear',
				'showMethod': 'fadeIn',
				'hideMethod': 'fadeOut',
			}

    
    // Check all 
   $('#checkall').click(function(){
      if($(this).is(':checked')){
         $('.delete_check').prop('checked', true);
      }else{
         $('.delete_check').prop('checked', false);
      }
   });

   // Delete record
   $('#delete_record').click(function(){
      var deleteids_arr = [];
      // Read all checked checkboxes
      $("input:checkbox[class=delete_check]:checked").each(function () {
         deleteids_arr.push($(this).attr('data-id'));
      });

      // Check checkbox checked or not
      if(deleteids_arr.length > 0){

         // Confirm alert
         var confirmdelete = confirm("Do you really want to Delete records?");
         if (confirmdelete == true) {

			
            $.ajax({
               url: '/admission/delete-multiple',
               type: 'post',
               data: {deleteids_arr: deleteids_arr},
               success: function(response){
				toastr.error('Record Deleted Successfuly !!')
                  $('#sample_data').DataTable().ajax.reload();
               }
            });
         } 
      }
   });
	$(document).on("click",".delBtn",function(){
		 if(confirm('Are you sure you want to delete this?')){
 const id = $(this).attr('data-id');
 $('.loader').css('display','block');
  $.ajax({
        url: '/admission/delete-admission',
        type: "POST",
        data: {
          id:id
        },
        success: function () {
        $('.loader').css('display','none');

     $('#sample_data').DataTable().ajax.reload();
	toastr.error('Record Deleted Successfuly !!')

        }
    });
		 }
 
});
	var dataTable = $('#sample_data').DataTable({
		"processing": true,
		"serverSide": true,
		
		"order":[],
		"ajax":{
			url:"/attendance/get-faculty",
			type:"POST",
		},
         columns: [
        { data: "created_at" },
      
         { data: "attendance_status" },
        { data: "check_in" },
        { data: "check_out" },
	],
		
	});
let startDates;
let endDates;
$(function() {

    var start = moment().subtract(29, 'days');
    var end = moment();

    function cb(start, end) {
        $('#reportrange span').html(start.format('YYYY-MM-DD') + ' - ' + end.format('YYYY-MM-DD'));
        startDates = start.format('YYYY-MM-DD');
         endDates = end.format('YYYY-MM-DD');
    }

    $('#reportrange').daterangepicker({
        startDate: start,
        endDate: end,
        ranges: {
           'Today': [moment(), moment()],
           'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           'Last 7 Days': [moment().subtract(6, 'days'), moment()],
           'Last 30 Days': [moment().subtract(29, 'days'), moment()],
           'This Month': [moment().startOf('month'), moment().endOf('month')],
           'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
    }, cb);

    cb(start, end);
    
});
 $(document).on('click','#filter_records', function () {
    
var facultyId = $("#faculty_id").val(); 

        if(facultyId == ""){
         alert("please select Faculty")
        }
        if (dataTable) {
                  dataTable.destroy();
                  dataTable.clear().draw();
    }
         dataTable = $('#sample_data').DataTable({
		"processing": true,
		"serverSide": true,
			 dom: 'Bfrtip',
   buttons: [
      {
         extend: 'csv',
        
         exportOptions: {
            columns: 'th:not(:last-child)'
         }
      },
       {
         extend: 'pdf',
        
         exportOptions: {
            columns: 'th:not(:last-child)'
         }
      }
   ],
		"order":[],
		"ajax":{
			url:"/attendance/get-faculty-attendance-report",
			type:"POST",
     data:{startDates:startDates,endDates:endDates,facultyId:facultyId},

		},
         columns: [
        { data: "created_at" },
        { data: "attendance_status" },
        { data: "check_in" },
        { data: "check_out" },
	],
		
	});
 
       
})
$(document).on('click','#filter_records_by_faculty', function () {
     if (dataTable) {
                  dataTable.destroy();
                  dataTable.clear().draw();
    }
         dataTable = $('#sample_data').DataTable({
		"processing": true,
		"serverSide": true,
			 dom: 'Bfrtip',
   buttons: [
      {
         extend: 'csv',
        
         exportOptions: {
            columns: 'th:not(:last-child)'
         }
      },
       {
         extend: 'pdf',
        
         exportOptions: {
            columns: 'th:not(:last-child)'
         }
      }
   ],
		"order":[],
		"ajax":{
			url:"/attendance/get-report-by-faculty",
			type:"POST",
    data:{startDates:startDates,endDates:endDates},
		},
         columns: [
        { data: "created_at" },
        { data: "attendance_status" },
        { data: "check_in" },
        { data: "check_out" },
	],
		
	});
       
})
 $(document).on('click','.checkedIn', function () {
   var currentDate = new Date();
// Extract individual time components
var hours = currentDate.getHours();
var minutes = currentDate.getMinutes();
var seconds = currentDate.getSeconds();

// Format the time
var formattedTime = hours + ':' + (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;

// Display formatted time
console.log("Formatted Time (HH:MM:SS):", formattedTime);
     if ('geolocation' in navigator) {
       navigator.geolocation.getCurrentPosition(function(position) { 
        let latitude = position.coords.latitude;
         let longitude = position.coords.longitude;
          $.ajax({
         url: `/attendance/checkin-faculty-attendance`,
         type: "post",
       data:{formattedTime:formattedTime,latitude:latitude,longitude:longitude},
         dataType: "json",
         cache: false,
         success: function (data) {
            console.log(data);
        if(data){
         toastr.success('Checked IN Successfuly !!')
        
$('#checkedIn').html("");
$('#checkedIn').removeClass("checkedIn");
$('#checkedIn').addClass("checkedOut");
$('#checkedIn').html("Check OUT");
      }else{
          toastr.error('You are not in range !!')
      }
          
          
        },
      });
          });
          } else { 
            console.log('Geolocation is not supported by this browser.');
          } 

   
       
})

$(document).on('click','.checkedOut', function () {
  
var currentDate = new Date();
// Extract individual time components
var hours = currentDate.getHours();
var minutes = currentDate.getMinutes();
var seconds = currentDate.getSeconds();

// Format the time
var formattedTime = hours + ':' + (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;


     if ('geolocation' in navigator) {
       navigator.geolocation.getCurrentPosition(function(position) { 
         console.log('Latitude:', position.coords.latitude);
          let latitude = position.coords.latitude;
          let longitude = position.coords.longitude;
          $.ajax({
         url: `/attendance/checkout-faculty-attendance`,
         type: "post",
         data:{formattedTime:formattedTime,latitude:latitude,longitude:longitude},
         dataType: "json",
         cache: false,
         success: function (data) {
            console.log(data);
             if( data.data === "not"){
           toastr.error('You are not in range !!')
       }
          if(data.data === "yes"){
         toastr.success('Checked OUT Successfuly !!')
                 // Get the element
               
$('#checkedOut').html("");
$('#checkedOut').removeClass("checkedOut");
$('#checkedOut').html("Checked OUT");
      }
      if(data.data === "no"){
          toastr.error('Check IN First to checkout !!')
      }
        },
      });
          });
          } else { 
            console.log('Geolocation is not supported by this browser.');
          } 

   
       
})
});	
</script>