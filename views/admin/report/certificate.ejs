<%- include('../../partials/top-bar') %>


      <!-- Site wrapper -->
      <div class="wrapper">
         <%- include('../../partials/header') %>
		
         <!-- =============================================== -->
         <!-- Left side column. contains the sidebar -->
       <%- include('../../partials/sidebar') %>
	
   
         <!-- =============================================== -->
         <!-- Content Wrapper. Contains page content -->
         <div class="content-wrapper">
			   
            <!-- Content Header (Page header) -->
            <section class="content-header">
               <div class="header-icon">
                  <i class="fa fa-dashboard"></i>
               </div>
               <div class="header-title">
                  <h1>SMART SCHOOL Dashboard</h1>
                  <small>Very detailed & featured admin.</small>
               </div>
            </section>
			
            <!-- Main content -->
            <section class="content">
          
			<div class="panel panel-bd lobidrag">
                        <div class="panel-heading">
                           <div class="btn-group" id="buttonexport">
                              <a href="#">
                                 <h4>All Certificate</h4>
                              </a>
                           </div>
                        </div>
                        <div class="panel-body">
                            
                            <%- include('../../partials/message') %>
                            <% if(user[0].role==="school"){ %>
					 <div class="row"> 
 <div class="col-md-6 text-left">
								 <input type="checkbox" class='checkall' id='checkall'> &nbsp;&nbsp; <input type="button" class="btn-sm btn-danger" id="multDel"  value='Check All & Delete' >

               
				
            </div>
           
            <div class="col-md-6 text-right">
 
                                 <a href="#" class="btn btn-add" data-toggle="modal" data-target="#addCertificate-lg"><i class="fa fa-plus"></i> Add New</a>  
                                 <input type="button" class="btn-sm btn-primary" id="multAssign"  value='Assign to Student' >
                                 
                             
            </div>
			<br>
        </div>

        <% } %>
		<br>

					<div class="table-responsive">
						
						<table id="sample_data" class="table table-bordered table-striped">
						
							<thead>
								<tr>
									<th></th>
									<th>Document Name</th>
									<th>Document Description</th>
									<th>class</th>
									<th class="noExport">Action</th>
								</tr>
							</thead>
						</table>
					</div>
				</div>
			</div>
		
            </section>
		

            <!-- /.content -->
         </div>
         <!-- /.content-wrapper -->
        <%- include('../../partials/footer') %>
      </div>
	 <!-- Modal1 -->
               <div class="modal fade" id="addCertificate-lg" tabindex="-1" role="dialog">
                  <%- include('../../partials/loader') %>
                  <div class="modal-dialog modal-lg"  role="document">
                     <div class="modal-content">
                        <div class="modal-header modal-header-primary">
                           <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                           <h3><i class="fa fa-plus m-r-5"></i> Add New Certificate</h3>
                        </div>
                        <div class="modal-body">
                           <div class="row">
                              <div class="col-md-12">
                                <form action="" id="certificateForm">
                                  <input type="hidden" id="certificate_school_id" value="<%= user[0].role=='school'?user[0].track_id:user[0].track_school_id %>" class="form-control" name="certificate_school_id" >
                            <div class="row">
                                <div class="form-group col-lg-6">
                                    <label>Certificate Name</label>
                                    <input type="text" id="certificate_name" class="form-control" name="certificate_name" required>
                                </div>
                                 <div class="form-group col-lg-6">
                                    <label>Class</label>
                                   <select name="certificate_class_id" id="certificate_class_id" class="form-control" required>
                                    <option value="">Please Select</option>
                                    <% for(let i = 0; i < data.length; i++){%> 
                                    <option value="<%= data[i].track_id %>"><%= data[i].class_name %></option>
                                       <% } %>
                                   </select>
                                </div>
                               
                                 <div class="form-group col-lg-6">
                                    <label>Certificate Description</label>
                                  
                                    <textarea id="certificate_desc" placeholder="certificate" rows="5" class="form-control" required name="certificate_desc"></textarea>
                                </div>
                              
                                <div class="form-group col-lg-6">
                                    <label>Upload Photo</label>
                                    <input type="file" id="certificate_photo" class="form-control" name="certificate_photo" required>
                                </div>
                            </div>
                            <div align="center">
                               <button class="	btn btn-success waves-effect waves-light "
															data-callback="onSubmit" id="saveStudent" data-action="submit">
															Create
														</button>
                            </div>
                        </form>
                              </div>
                           </div>
                        </div>
                        <div class="modal-footer">
                           <button type="button" class="btn btn-danger pull-left" data-dismiss="modal">Close</button>
                        </div>
                     </div>
                     <!-- /.modal-content -->
                  </div>
                  <!-- /.modal-dialog -->
               </div>
              
                <div class="modal fade" id="deleteCertificateModal" tabindex="-1" role="dialog">
                   <%- include('../../partials/loader') %>
                  <div class="modal-dialog">
                     <div class="modal-content">
                        <div class="modal-header modal-header-primary">
                           <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                           <h3><i class="fa fa-minus m-r-5"></i> Remove Certificate</h3>
                        </div>
                        <div class="modal-body">
                         
                              <div id="deleteCertificateDiv">
                                    
                           </div>
                        </div>
                        <div class="modal-footer">
                           <button type="button" class="btn btn-danger pull-left" data-dismiss="modal">Close</button>
                        </div>
                     </div>
                     <!-- /.modal-content -->
                  </div>
                  <!-- /.modal-dialog -->
               </div>
                  <div class="modal fade" id="deleteMultipleCertificateModal" tabindex="-1" role="dialog">
                      <%- include('../../partials/loader') %>
                  <div class="modal-dialog">
                     <div class="modal-content">
                        <div class="modal-header modal-header-primary">
                           <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                           <h3><i class="fa fa-minus m-r-5"></i> Remove Certificate</h3>
                        </div>
                        <div class="modal-body">
                         
                              <div id="deleteMultipleCertificateDiv">
                               
                             
                           </div>
                        </div>
                        <div class="modal-footer">
                           <button type="button" class="btn btn-danger pull-left" data-dismiss="modal">Close</button>
                        </div>
                     </div>
                     <!-- /.modal-content -->
                  </div>
                  <!-- /.modal-dialog -->
               </div>
                 <div class="modal fade" id="asignMultipleCertificateModal" tabindex="-1" role="dialog">
                      
                  <div class="modal-dialog">
                     <div class="modal-content">
                        <div class="modal-header modal-header-primary">
                           <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                           <h3><i class="fa fa-plus m-r-5"></i> Assign Certificate</h3>
                        </div>
                        <div class="modal-body">
                          <input type="checkbox" class='assignAllClass' id='assignAllClass'> &nbsp;class wise &nbsp;&nbsp;&nbsp;
                          <input type="checkbox" class='assignAllstudent' id='assignAllschool'> &nbsp;school wise

                          <input type="hidden" name="classValue" id="classValue">
                          <input type="hidden" name="schoolValue" id="schoolValue">
                        </br>
                              <div id="asignMultipleCertificateDiv">
                               
                             
                           </div>
                        </div>
                        <div class="modal-footer">
                           <button type="button" class="btn btn-danger pull-left" data-dismiss="modal">Close</button>
                        </div>
                     </div>
                     <!-- /.modal-content -->
                  </div>
                  <!-- /.modal-dialog -->
               </div>
                 <%- include('../../partials/loader') %>
                 <div class="modal fade" id="editCertificateModal" tabindex="-1" role="dialog">
                 
                  <div class="modal-dialog modal-lg"  role="document">
                     <div class="modal-content">
                        <div class="modal-header modal-header-primary">
                           <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                           <h3><i class="fa fa-plus m-r-5"></i> Edit Certificate Details</h3>
                        </div>
                        <div class="modal-body">
                         
                              <div id="editCertificateDiv">
                               
                             
                           </div>
                        </div>
                        <div class="modal-footer">
                           <button type="button" class="btn btn-danger pull-left" data-dismiss="modal">Close</button>
                        </div>
                     </div>
                     <!-- /.modal-content -->
                  </div>
                  <!-- /.modal-dialog -->
               </div>
                  <div class="modal fade" id="viewCertificateModal" tabindex="-1" role="dialog">
                  <div class="modal-dialog modal-lg"  role="document">
                     <div class="modal-content">
                        <div class="modal-header modal-header-primary">
                           <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                           <h3><i class="fa fa-plus m-r-5"></i> View Certificate Details</h3>
                        </div>
                        <div class="modal-body">
                         
                              <div id="viewCertificateDiv">
                               
                             
                           </div>
                        </div>
                        <div class="modal-footer">
                           <button type="button" class="btn btn-danger pull-left" data-dismiss="modal">Close</button>
                        </div>
                     </div>
                     <!-- /.modal-content -->
                  </div>
                  <!-- /.modal-dialog -->
               </div>
               
      <!-- /.wrapper -->
      <!-- Start Core Plugins
        
         =====================================================================-->
   <%- include('../../partials/footer-script') %>

   <script  type="text/javascript" language="javascript">

document.addEventListener("click", function(event) {
    const target = event.target;
    if (target.classList.contains("editBtn")) {
        editCertificate(target.dataset.id);
    } else if (target.classList.contains("deleteBtn")) {
        deleteCertificate(target.dataset.id);
    } else if (target.classList.contains("viewBtn")) {
        viewCertificate(target.dataset.id);
    }
});
$(document).on('change','#classes', function () {
   var id = $(this).val(); 
  $.ajax({
         url: `/report/fetch-student-by-class`,
         type: "post",
         data:{classId:id},
         dataType: "json",
         cache: false,
          beforeSend: function() {
          $('#loader').removeClass('hidden')
             },
         success: function (data) {
            console.log(data);
         let option;
        for(let i=0; i<data.length; i++){
           option += `<option value="${data[i].track_id}">${data[i].name}</option>`
        }
             $("#student").html("");
             
             $("#student").html(`<option value="">Please Select.</option>`);
            $("#student").append(option);
          
          
          
        },
         complete: function(){
                      $('#loader').addClass('hidden')
                      },
      });
})

   $('#assignAllClass').change(function(){
      if($(this).is(':checked')) {
        $('#student').prop('disabled', true);
        $('#classValue').val('class');

      } else {
        $('#student').prop('disabled', false);
             $('#classValue').val('');

      }
    });

    $('#assignAllschool').change(function(){
    if ($(this).is(':checked')) {
        $('#schoolValue').val('school');
         $('#classValue').val('');
        $('#student').prop('disabled', true);
        $('#classes').prop('disabled', true);
        $('#assignAllClass').prop('disabled', true);
    } else {
        if (!$('#assignAllClass').is(':checked')) {
            $('#student').prop('disabled', false);
              $('#classValue').val('');
        }else{

           $('#classValue').val('class');
        }
          $('#schoolValue').val('');
        $('#classes').prop('disabled', false);
        $('#assignAllClass').prop('disabled', false);
    }
});

$(document).on('click','#assign', function () {
   var classId = $('#classes').val(); 
   var studentId = $('#student').val();
   let schoolValue =  $('#schoolValue').val();
       let classValue =  $('#classValue').val(); 
   // Read all checked checkboxes
   if($('#assignAllClass').is(':checked') && classId ==""){
      toastr.error("Please select Class !!")
   }else{
      
      var certificate = [];
      $("input:checkbox[class=delete_check]:checked").each(function () {
         certificate.push($(this).attr('data-id'));
      });
       
     
      // Check checkbox checked or not
      if(certificate.length > 0){
  $.ajax({
         url: `/report/assign-certificate`,
         type: "post",
         data:{classId:classId,studentId:studentId,certificate:certificate,schoolValue:schoolValue,classValue:classValue },
         dataType: "json",
         success: function (data) {
            console.log(data);
             if (data) {
            toastr.success("Exam(s) Assigned Successfully!"); // Display success message
        } else {
            toastr.error("All Exams are Already Assigned!"); // Display error message
        }
            
        },
         
      });
      }else{
         toastr.error("Checkbox are not selected !")
      }
   }
})
     
        $("#certificateForm").on("submit", async e => {
         
							e.preventDefault();
							try {
								
									const formData = new FormData($(`#${e.target.id}`)[0]);
									e.preventDefault();
									$.ajax({
										url: `/report/create-certificate`,
										type: "post",
										processData: false,
										contentType: false,
										
										data: formData,
										dataType: "json",
                     beforeSend: function() {
                     $('#loader').removeClass('hidden')
                     },
										success: function (data) {
                      
                     
                  if (data) {
                       const url = '/success.mp3'
                    const audio = new Audio(url);
                    audio.play();
                     Swal.fire({
                    position: "top-center",
                    icon: "success",
                    title: "Application Saved Successfully !!",
                    showConfirmButton: false,
                    timer: 2000,
                  });
                $("#certificateForm")[0].reset();
                  $("#addCertificate-lg").modal("hide");
                  $('#sample_data').DataTable().ajax.reload();
                
                } else {
                    Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "Data Allready Exist !",
                  });
                
                }
										
										},
                      complete: function(){
                      $('#loader').addClass('hidden')
                      },
									});

								

							} catch (e) {
								console.error(e)
							}
						});
                 
                 

       
function viewCertificate(certificateId) {
    try {
     
      $("#viewCertificateDiv").html("");
      $("#viewCertificateModal").modal("toggle");
      $.ajax({
         url: `/report/view-certificate-byid`,
         type: "post",
         data:{certificateId:certificateId},
         dataType: "json",
         cache: false,
         beforeSend: function() {
          $('#loader').removeClass('hidden')
             },
         success: function (data) {
    console.log(data);
            let formDetails = ``;
            formDetails += `<table class="table table-bordered table-striped"> 
               
               <tr><td>Photo</td><td><img src="/uploads/${data[0].track_school_id}/document/${data[0].certificate_photo}" width="100px"></td></tr>
               <tr><td>Class Name</td><td>${data[0].class_name}</td></tr>
               <tr><td>Certificate Name</td><td>${data[0].certificate_name}</td></tr>
               <tr><td>Certificate desc</td><td>${data[0].certificate_desc}</td></tr>
               
              
               </table>`;
            $("#viewCertificateDiv").html(formDetails);
          
        },
          complete: function(){
                      $('#loader').addClass('hidden')
                      },
      });
    } catch (err) {
      console.error(err);
    }
  }

                  function editCertificate(certificateId) {
    try {
     
      $("#editCertificateDiv").html("");
      $("#editCertificateModal").modal("toggle");
      $.ajax({
         url: `/report/fetch-certificate-byid`,
         type: "post",
         data:{certificateId:certificateId},
         dataType: "json",
         cache: false,
         beforeSend: function() {
            $('#loader').removeClass('hidden')
            },
         success: function (data) {
        console.log(data);
        let option;
        for(let i=0; i<data.classes.length; i++){
           option += `<option value="${data.classes[i].track_id}"${data.data[0].track_class_id==data.classes[i].track_id?'selected':""}>${data.classes[i].class_name}</option>`
        }
            let formDetails = ``;
            formDetails += `<form action="/report/update-certificate-by-id" method="post" enctype="multipart/form-data">
                                  <input type="hidden"  value="${certificateId}" class="form-control" name="certificate_id">
                            <div class="row">
                                <div class="form-group col-lg-6">
                                    <label>Certificate Name</label>
                                    <input type="text" class="form-control" value="${data.data[0].certificate_name}" name="certificate_name">
                                </div>
                                   <div class="form-group col-lg-6">
                                    <label>Class</label>
                                   <select name="student_class_id" class="form-control">
                                    <option value="">Please Select</option>
                                   ${option}
                                   </select>
                                </div>
                                 <div class="form-group col-lg-6">
                                    <label>Certificate Desc</label>
                                    <textarea placeholder="certificate" rows="5" class="form-control" name="certificate_desc">${data.data[0].certificate_desc}</textarea>
                                </div>
                              
                                <div class="form-group col-lg-6">
                                
                                    <label>Upload Photo</label>
                                     <img src="/uploads/${data.data[0].track_school_id}/document/${data.data[0].certificate_photo}" width="100px">
                                    <input type="file" class="form-control" name="certificate_photo">
                                </div>
                            </div>
                            <div align="center">
                               <input type="submit" class="btn btn-success"
															value="Update">
															
														
                            </div>
                        </form>`;
            $("#editCertificateDiv").html(formDetails);
          
        },
          complete: function(){
                      $('#loader').addClass('hidden')
                      },
      });
    } catch (err) {
      console.error(err);
    }
  }
  
   function deleteCertificate(certificateId) {
    try {
     
      $("#deleteCertificateDiv").html("");
      $("#deleteCertificateModal").modal("toggle");
   
          
            let formDetails = ``;
            formDetails += `
                    <input type="hidden" class="form-control" name="certificateId" id="certificateId" value="${certificateId}">
                   
                    
                   <div class="col-md-12">
                    Are You Sure. ?
                   </div>

                   <div class="text-center mt-3">
                    <a  class="btn btn-danger waves-effect waves-light" data-bs-dismiss="modal"> No </a>
                     <button
                       type="submit"
                       class="btn btn-primary delBtn waves-effect waves-light"
                       id="register"
                     >
                       Yes
                     </button>
                   </div>
                 </form> `;
            $("#deleteCertificateDiv").html(formDetails);
          
       
    } catch (err) {
      console.error(err);
    }
  }
    
$(document).ready(function(){
	

	toastr.options = {
				'closeButton': true,
				'debug': false,
				'newestOnTop': false,
				'progressBar': true,
				'positionClass': 'toast-top-center',
				'preventDuplicates': false,
				'showDuration': '1000',
				'hideDuration': '1000',
				'timeOut': '5000',
				'extendedTimeOut': '1000',
				'showEasing': 'swing',
				'hideEasing': 'linear',
				'showMethod': 'fadeIn',
				'hideMethod': 'fadeOut',
			}

    
    // Check all 
   $('#checkall').click(function(){
      if($(this).is(':checked')){
         $('.delete_check').prop('checked', true);
      }else{
         $('.delete_check').prop('checked', false);
      }
   });
     // Check all 
   $('#multDel').click(function(){
  if($('.delete_check:checked').length > 0){
 
       
      $("#deleteMultipleCertificateDiv").html("");
      $("#deleteMultipleCertificateModal").modal("toggle");
   
          
            let formDetails = ``;
            formDetails += `
                  
                   <div class="col-md-12">
                    Are You Sure. ?
                   </div>

                   <div class="text-center mt-3">
                    <a  class="btn btn-danger waves-effect waves-light" data-bs-dismiss="modal"> No </a>
                     <button
                       type="submit"
                       class="btn btn-primary waves-effect waves-light"
                       id="delete_record"
                    
                     >
                       Yes
                     </button>
                   </div>
                 `;
            $("#deleteMultipleCertificateDiv").html(formDetails);
            }else{
                toastr.error("Please select at least one checkbox !")

 }
      
   });

    $('#multAssign').click(function(){
  if($('.delete_check:checked').length > 0){
  
      $("#asignMultipleCertificateDiv").html("");
      $("#asignMultipleCertificateModal").modal("toggle");
    $.ajax({
         url: `/report/get-class`,
         type: "post",
         data:{},
         dataType: "json",
         cache: false,
          beforeSend: function() {
          $('#loader').removeClass('hidden')
             },
         success: function (data) {
            console.log(data);
         let option;
        for(let i=0; i<data.length; i++){
           option += `<option value="${data[i].track_id}">${data[i].class_name}</option>`
        }
             $("#classes").html("");
             
             $("#classes").html(`<option value="">Please Select.</option>`);
            $("#classes").append(option);
          
          
          
        },
         complete: function(){
                      $('#loader').addClass('hidden')
                      },
      });
          
            let formDetails = ``;
            formDetails += `
                            <div class="row">
                             
                                   <div class="form-group col-lg-6">
                                    <label>Class</label>
                                   <select name="student_class_id" id="classes" class="form-control">
                                    <option value="">Please Select</option>
                                  
                                   </select>
                                </div>
                                  <div class="form-group col-lg-6">
                                    <label>Student</label>
                                   <select name="student_class_id" class="form-control" id="student">
                                    <option value="">Please Select</option>
                                  
                                   </select>
                                </div>
                               
                            </div>
                            <div align="center">
                               <input type="submit" id="assign" class="btn btn-success"
															value="Assign">
															
														
                            </div>
                       
                 `;
            $("#asignMultipleCertificateDiv").html(formDetails);
            }else{
   toastr.error("Please select at least one Certificate !")

 }
      
   });

   // Delete record
   $(document).on('click','#delete_record',function(){
      var deleteids_arr = [];
      // Read all checked checkboxes
      $("input:checkbox[class=delete_check]:checked").each(function () {
         deleteids_arr.push($(this).attr('data-id'));
      });
      // Check checkbox checked or not
      if(deleteids_arr.length > 0){
        
            $.ajax({
               url: '/report/delete-multiple',
               type: 'post',
               data: {deleteids_arr: deleteids_arr},
               beforeSend: function() {
                     $('#loader').removeClass('hidden')
                     },
               success: function(response){
                   $("#deleteMultipleCertificateModal").modal("hide");
				toastr.error('Record Deleted Successfuly !!')
                  $('#sample_data').DataTable().ajax.reload();
               },
                 complete: function(){
                      $('#loader').addClass('hidden')
                      },
            });
         
      }
   });
	$(document).on("click",".delBtn",function(){
		
 const certificateId = $("#certificateId").val();
  $.ajax({
        url: '/report/delete-certificate',
        type: "POST",
        data: {
          certificateId:certificateId,
        
        },
        beforeSend: function() {
                     $('#loader').removeClass('hidden')
                     },
        success: function (data) {
      $("#deleteCertificateModal").modal("hide");
     $('#sample_data').DataTable().ajax.reload();
	toastr.error('Record Deleted Successfuly !!')

        },
          complete: function(){
                      $('#loader').addClass('hidden')
                      },
    });
	
});
	
var dataTable = $('#sample_data').DataTable({
		"processing": true,
		"serverSide": true,
		 dom: 'Bfrtip',
   buttons: [
      {
         extend: 'csv',
         exportOptions: {
            columns: 'th:not(:last-child)'
         }
      },
       {
         extend: 'pdfHtml5',
        
         exportOptions: {
            columns: 'th:not(:last-child)'
         }
      }
   ],
		"order":[],
		"ajax":{
			url:"/report/get-certificate",
			type:"POST",
		},
         columns: [
        { data: "check" },
        { data: "certificate_name" },
        { data: "certificate_desc" },
        { data: "class_name" },
        { data: "action" },
	],
		
	});

	
});	
setTimeout(function () {
    $("#error").hide();
  }, 3000);
  setTimeout(function () {
    $("#error_msg").hide();
  }, 3000);
  setTimeout(function () {
    $("#success_msg").hide();
  }, 3000);
</script>